#! /bin/bash

## This script runs the JUnit tests (directly, without using Eclipse)
## It does so by running the Test.java program, after compiling all the
## unit test drivers in OpenJMLTest/src/org/jmlspecs/openjmltest/testcases/

## $R is the location of the directory containing this script, with
## $R/.. expected to be OpenJMLTest, which should be a sibling of OpenJML21

R=$( cd $(dirname "$BASH_SOURCE") && pwd)
ROOT=$R/../../OpenJML21
JROOT=$R/../libs
JUNIT="$JROOT/junit-4.13.2.jar:$JROOT/hamcrest-core-1.3.jar:$JROOT/junit-jupiter-api-5.5.2.jar:$JROOT/apiguardian-api-1.1.0.jar"
NJAVAC=$ROOT/build/*/jdk/bin/javac
NJAVA=$ROOT/build/*/jdk/bin/java


cd $R
rm -f *.class
CL=`echo $ROOT/build/*/jdk/modules/*  | grep -v META | sed -e "s/ /:/g"`
CP=".:../src:$JUNIT:$CL"

NOJML= $NJAVAC -Xlint:unchecked -cp $CP Test.java ../src/org/jmlspecs/openjmltest/testcases/escall2.java 
( cd ..; OPENJML_ROOT="$ROOT/../../Solvers" $NJAVA -cp unittests:src:$JUNIT --add-modules jdk.compiler,java.base Test $@ 2>&1 )
exit $?
##NOJML= $NJAVAC -Xlint:unchecked -cp $CP -p /Users/davidcok/projects/OpenJML21/OpenJML/OpenJML21/build/macosx-x86_64-server-release/jdk/modules --add-modules jdk.compiler,java.base Test.java ../src/org/jmlspecs/openjmltest/testcases/*.java 

while ! NOJML= $NJAVAC -Xlint:unchecked -cp $CP Test.java ../src/org/jmlspecs/openjmltest/testcases/*.java ; do

   # Build can fail because of race conditions between compiles if so then multiple runtests are started at once
   echo Build failed for $@
   sleep 10
done
echo COMPILED
( cd ..; OPENJML_ROOT="$ROOT/../../Solvers" $NJAVA -cp unittests:src:$JUNIT --add-modules jdk.compiler,java.base Test $@ 2>&1 )
